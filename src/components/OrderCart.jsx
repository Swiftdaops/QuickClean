"use client";
import React, { useState, useEffect } from "react"; const SERVICE_PRICES = { 'Lodge Clean': 5000, 'Help Me Buy Pack': 1500
};
// Add Home & Apartment price
SERVICE_PRICES['Home & Apartment'] = 15000; export default function OrderCart() { const [name, setName] = useState(""); const [phone, setPhone] = useState(""); const [service, setService] = useState("Lodge Clean"); const [price, setPrice] = useState(SERVICE_PRICES['Lodge Clean']); const [stores, setStores] = useState([]); const [store, setStore] = useState(""); const [cart, setCart] = useState([]); const [loading, setLoading] = useState(false); const [message, setMessage] = useState(null); function addToCart(e) { e && e.preventDefault(); const item = { service, price: Number(price), store: service === 'Help Me Buy Pack' ? store : undefined }; setCart((c) => [...c, item]); setMessage({ type: 'info', text: `Added ${service} — ₦${formatCurrency(item.price)}` }); } function removeItem(idx) { setCart((c) => c.filter((_, i) => i !== idx)); } function total() { return cart.reduce((s, it) => s + (Number(it.price) || 0), 0); } async function submitOrder() { if (!name || !phone || cart.length === 0) { setMessage({ type: "error", text: "Please provide name, phone and add at least one service." }); return; } setLoading(true); setMessage(null); try { const apiBase = process.env.NEXT_PUBLIC_API_URL || "http://localhost:3001"; const res = await fetch(`${apiBase}/api/bookings`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, phone, services: cart }), }); const body = await res.json(); if (!res.ok) throw new Error(body.message || JSON.stringify(body)); setMessage({ type: "success", text: `Order placed (${body.bookings?.length || 0} items).` }); setCart([]); setName(""); setPhone(""); } catch (err) { setMessage({ type: "error", text: `Order failed: ${err.message}` }); } finally { setLoading(false); } } function formatCurrency(n) { try { return new Intl.NumberFormat('en-NG', { style: 'decimal' }).format(n); } catch (e) { return String(n); } } // keep price in sync when switching service React.useEffect(() => { const p = SERVICE_PRICES[service] ?? 0; setPrice(p); }, [service]); // fetch available stores from backend and set default useEffect(() => { let mounted = true; const apiBase = process.env.NEXT_PUBLIC_API_URL || "http://localhost:3001"; async function loadStores() { try { const res = await fetch(`${apiBase}/api/stores`); if (!res.ok) throw new Error('Failed to load stores'); const j = await res.json(); const names = (j.stores || j || []).map((s) => s.name || s); if (!mounted) return; setStores(names); if (!store && names.length) setStore(names[0]); } catch (err) { // keep default empty; show a gentle message in UI console.error('Could not load stores for OrderTest', err); } } loadStores(); return () => { mounted = false }; }, []); return ( <div className="max-w-3xl mx-auto p-6"> <h2 className=" font-semibold mb-4">Order Test — Lodge Clean / Help Me Buy</h2> <div className="grid gap-4"> <div className="grid grid-cols-1 sm:grid-cols-2 gap-4"> <div> <label className="block font-medium mb-1">Name</label> <input value={name} onChange={(e) => setName(e.target.value)} className="w-full rounded border px-3 py-2" /> </div> <div> <label className="block font-medium mb-1">Phone</label> <input value={phone} onChange={(e) => setPhone(e.target.value)} className="w-full rounded border px-3 py-2" placeholder="e.g. +2348012345678" /> </div> </div> <form onSubmit={addToCart} className="grid grid-cols-1 md:grid-cols-4 gap-3 items-end"> <div> <label className="block font-medium mb-1">Service</label> <div className="flex items-center space-x-2"> <button type="button" onClick={() => setService('Lodge Clean')} className={`px-3 py-1 rounded ${service === 'Lodge Clean' ? ' ' : ''}`}>Lodge Clean</button> <button type="button" onClick={() => setService('Help Me Buy Pack')} className={`px-3 py-1 rounded ${service === 'Help Me Buy Pack' ? ' ' : ''}`}>Help Me Buy</button> <button type="button" onClick={() => setService('Home & Apartment')} className={`px-3 py-1 rounded ${service === 'Home & Apartment' ? ' ' : ''}`}>Home & Apartment</button> </div> </div> <div> <label className="block font-medium mb-1">Price (₦)</label> <input type="number" value={price} onChange={(e) => setPrice(e.target.value)} className="w-full rounded border px-3 py-2" /> <div className=" mt-1">Suggested: ₦{formatCurrency(SERVICE_PRICES[service] ?? 0)}</div> </div> <div> <label className="block font-medium mb-1">Store</label> <select value={store} onChange={(e) => setStore(e.target.value)} disabled={service !== 'Help Me Buy Pack'} className="w-full rounded border px-3 py-2 disabled:opacity-60"> {stores.length > 0 ? ( stores.map((s) => ( <option key={s} value={s}>{s}</option> )) ) : ( <option value="">No stores available</option> )} </select> {service !== 'Help Me Buy Pack' && <div className=" mt-1">Store only used for Help Me Buy</div>} </div> <div className="flex gap-2"> <button type="submit" className="px-4 py-2 rounded ">Add</button> <button type="button" onClick={() => { setCart([]); setMessage(null); }} className="px-3 py-2 rounded border">Clear</button> </div> </form> <div className=" rounded shadow p-4"> <h3 className="font-medium mb-2">Cart</h3> {cart.length === 0 && <div className=" ">No items added.</div>} <ul className="space-y-2"> {cart.map((it, idx) => ( <li key={idx} className="flex items-center justify-between"> <div> <div className="font-medium">{it.service}</div> <div className=" ">₦{formatCurrency(it.price)}{it.store ? ` • ${it.store}` : ''}</div> </div> <div> <button onClick={() => removeItem(idx)} className=" ">Remove</button> </div> </li> ))} </ul> <div className="mt-3 font-semibold">Total: ₦{formatCurrency(total())}</div> </div> <div className="flex items-center gap-3"> <button onClick={submitOrder} disabled={loading} className="px-4 py-2 rounded ">{loading ? 'Sending...' : 'Place Order'}</button> {message && ( <div className={`px-3 py-2 rounded ${message.type === 'error' ? ' ' : message.type === 'success' ? ' ' : ' '}`}>{message.text}</div> )} </div> </div> </div> );
}
